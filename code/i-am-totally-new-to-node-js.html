<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Lmovingon - Code</title>
    <script src="../javascripts/jquery-min.js"></script>
    <script src="../javascripts/jquery.easing.1.3.js"></script>
    <script src="../javascripts/index.js"></script>
    <link rel="stylesheet" href="../stylesheets/base.css">
    <link rel="stylesheet" href="../stylesheets/baserps.css">
    <link rel="stylesheet" href="../stylesheets/code.css">
    <link rel="stylesheet" href="../stylesheets/coderps.css">
    <link rel = "Shortcut Icon" href="../images/favicon.ico">
    <link rel="stylesheet" href="../prettify/prettify.css">
</head>
<body onload="prettyPrint()">
    <div id="navmenu">
       <div id="nav">
            <a href="../index.html" id="logo"></a>
            <ul id="menu">
                <li><a href="../index.html">Home</a></li>
                <li><a href="../code.html">Code</a></li>
                <li><a href="https://l-movingon.github.com/resume">About</a></li>
                <li><a href="../contact.html">Contact</a></li>
            </ul>
<!--            hanburger menu when the screen's width less than 768px-->
            <img src="../images/menu.png" id="Hmenu">
<!--            hanburget menu drop down -->
            <div id="HMDDBox">
                <ul id="HMDD">
                    <li><a href="../index.html">Home</a></li>
                    <li><a href="../code.html">Code</a></li>
                    <li><a href="https://l-movingon.github.com/resume">About</a></li>
                    <li><a href="../contact.html">Contact</a></li>
                </ul>
            </div>
        </div>
    </div>
    <div id="navoverlay"></div>
    <div id="header">
        <div id="title">
            <h1>GIVEN&nbsp;ENOUGH&nbsp;EYEBALLS</h1>
            <h1>ALL&nbsp;BUGS&nbsp;ARE&nbsp;SHALLOW<span id="split">|</span></h1> 
        </div>
        <div id="overlay"></div>
    </div>
    <div id="container">
        <div id="sideBar">
            <ul><a class="linkhere" name="h5c3">HTML5 & CSS3</a>
                <li><a href="why-we-still-need-web-safe-fonts.html">Why We Still Need Web-safe Fonts</a></li>
                <li><a href="image-optimization.html">Image optimization</a></li>
                <li><a href="7-tips-for-improving-your-user-interface-design.html">7 Tips For Improving Your User Interface Design</a></li>
                <li><a href="what-is-the-dom.html">What is the DOM</a></li>
            </ul>
            <ul><a class="linkhere" name="js">JavaScript</a>
                <li><a href="about-closures.html">About Closures</a></li>
                <li><a href="about-event-loop.html">About Event Loop</a></li>
                <li><a href="''-string('')-new-string('').html">'', String(''), new String('')</a></li>
                <li><a href="about-hoisting.html">About Hoisting</a></li>
                <li><a href="about-this.html">About This</a></li>
                <li><a href="about-array-like.html">About Array-like</a></li>
                <li><a href="singleton-pattern.html">singleton pattern</a></li>
                <li><a href="getter-and-setter.html">getter and setter</a></li>
                <li><a href="i-am-totally-new-to-node-js.html" style="color: #209BD7">Hi, I'm totally new to Node.js</a></li>
                <li><a href="node-js-in-action-note.html">Node.js in action note</a></li>
                <li><a href="array-prototype.html">Array.prototype.?</a></li>
                <li><a href="es6-in-depth-an-introduction.html">ES6 in depth - An Introduction</a></li>
            </ul>
            <ul><a class="linkhere" name="ext">Ext js</a>
                <li><a href="ext-gridpanel-with-paging-upload.html">upload gridpanel with paging</a></li>
            </ul>
            <ul><a class="linkhere" name="react">React js</a>
                <li><a href="playlist-with-react.html">Playlist with react</a></li>
            </ul>
        </div>
        <div id="main">
            <h1>Hi, I'm totally new to Node.js</h1>
            <p>看完了《node.js入门》这本书，然后远成介绍看 《node.js in action》，现在看到了第六章。 书在第二章的时候介绍了怎么写一个 chatroom ，里面也有完整的代码，这里就不再说了，我们直接来看看他的效果</p>
            <p>下面介绍一下我是怎么学习 node.js 的</p>
            <h3>For getting started, book is good, but API is the best</h3>
            <br>
            <p>在看《node.js in action》的时候，他在第二章的时候就给我们展示了一个较为复杂的实例，所以会有很多的代码我们都不知道是什么意思，虽然在书的后面会一个一个的给我们解释。但是在代码的第一行就不懂的时候，你还怎么可以淡定下去~ 所以最好的方法就是不懂就查API</p>
            <p>在js的第一行我们会经常看到 <code class="code">var http = require('http');</code> 、<code class="code">var fs = require('fs');</code> ，为什么我们可以加载这些模块，加载了这些模块之后又有什么用，我们要怎么用，这些问题都可以通过 API 解决。</p>
            <p>我们来看看 <a href="https://nodejs.org/api/">node.js 的 API 文档</a></p>
            <p>1. 我们可以知道我们经常使用的 http.createServer(function(req, res) {}).listen(8000); 其实是创建一个服务器，当别人请求这个端口的时候，就会触发 request 事件</p>
            <p>2. 我们也可以知道 fs 就是我们的 File System ，他可以对我们的文件进行一系列的操作</p>
            <p>3. 我们也可以知道 events 可以用来监听和执行我们的事件</p>
            <p>4. 我们也可以知道 net 也像 http 那样有一个 createServer 的方法，但是不同的是， net 是监听别人的 connection 事件</p>
            <p style="font-weight:bold">所以说 API在手, 问题都赶走</p>
            <h3>A simple dos chatroom demo</h3>
            <br>
            <p style="font-weight:bold">自己动手做，印象才够深</p>
            <p>现在我们来做一个简单的 dos chatroom</p>
            <p>我们可以描述一下整个过程，多个dos连接到服务器，然后在任意一个dos里输入东西，其他dos都会显示输入的内容，想想我们用到了哪些模块</p>
            <p>1. dos连接到服务器，所以我们可以用 net.createServer 来监听dos的 connection 事件</p>
            <p>2. 当dos输入内容的时候，其他的dos会响应，去执行一些事件，我们可以用 events 来做</p>
            <p>所以我们建好了一个 a-simple-dos-chatroom.js 文件，在里面加上下面两行代码</p>
            <div class="codeHighLine">&nbsp;Code
                <pre class="prettyprint linenums">
var net = require('net');
var events = require('events');
</pre>
            </div>
            <p>先用 net 创建一个服务器，然后监听一个端口号，这里我用3000</p>
            <div class="codeHighLine">&nbsp;Code
                <pre class="prettyprint linenums">
net.createServer(function(client) {
    //client 是连接到这个端口的 socket 的一个实例
    //为每个实例一个id 后面会用到
    var id  = client.remoteAddress + ':' + client.remotePort;
}).listen(3000);
</pre>
            </div>
            <p>当多个dos连接到同一个服务器的时候一起聊天时，我们可以认为他们处于同一个频道下，而这个频道就要来监听每个dos的操作，还要对每个dos进行显示</p>
            <p>通过API，我们可以知道要用 events 来监听和执行事件，要创建 events.EventEmitter 这个类的实例，所以我们来创建这个实例 channel，然后我们为这个 channel 实例定义一个  clients 的对象，是用来装载登录后的用户</p>
            <div class="codeHighLine">&nbsp;Code
                <pre class="prettyprint linenums">
var channel = new events.EventEmitter;
channel.clients = {};
</pre>
            </div>
            <p> net.createServer 会监听用户的 connection 事件，当他们连接后，我们就会执行 join 这个事件，所以在此之前，我们可以先定义，或者叫先监听这个 join 这个方法</p>
            <div class="codeHighLine">&nbsp;Code
                <pre class="prettyprint linenums">
channel.on('join', function(id, client){
    this.clients[id] = client;
    this.clients[id].write('welcome to dos chatroom');
});
</pre>
            </div>
            <p>然后我们再在 net.createServer 回调函数里执行这个 join 方法</p>
            <div class="codeHighLine">&nbsp;Code
                <pre class="prettyprint linenums">
channel.emit('join', id, client);
</pre>
            </div>
            <p>现在已经就差最后一步了，就是当我们在自己dos里输入东西的时候，其他的dos也会输出相同的东西，那有什么办法可以监听我们每个client有没有输入东西呢</p>
            <p style="font-weight:bold">查API</p>
            <p>我们找到了 data 这个事件，那好，我们有 client 去监听他，监听到 data 改变后，我们执行 broadcast 方法</p>
            <div class="codeHighLine">&nbsp;Code
                <pre class="prettyprint linenums">
client.on('data', function(data) {
    channel.emit('broadcast', id, data);
});
</pre>
            </div>
            <p>然后我们再定义 broadcast 这个方法</p>
            <div class="codeHighLine">&nbsp;Code
                <pre class="prettyprint linenums">
channel.on('broadcast', function(id, data) {
    for(var index in this.clients) {
        this.clients[index].write(data);
    }
});
</pre>
            </div>
            <p>这时我们会发现一个问题，就是在输入的那个dos里面，会重复我们输入的东西，因为 broadcast 里对每个 client 都写出了数据，所以我们可以做一个判断</p>
            <div class="codeHighLine">&nbsp;Code
                <pre class="prettyprint linenums">
channel.on('broadcast', function(id, data) {
    for(var index in this.clients) {
        if(index != id) {
            this.clients[index].write(data);
        }
    }
});
</pre>
            </div>
            <p>到这里，就完成了我们的功能了 :-m 快用 node 跑一下吧 然后用 telnet 连接一下 和自己聊聊天吧!</p>
            <div id="disqus_thread"></div>
            <script type="text/javascript">
                /* * * CONFIGURATION VARIABLES * * */
                var disqus_shortname = 'lmovingon';
                
                /* * * DON'T EDIT BELOW THIS LINE * * */
                (function() {
                    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
                    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
                })();
            </script>
            <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
        </div>
    </div>
    <div id="footer">
        <div id="copyright">© Copyright&nbsp;2015&nbsp;&nbsp;Lmovingon</div>
    </div>
    <script src="../prettify/prettify.js"></script>
    <script type="text/javascript">
        /* * * CONFIGURATION VARIABLES * * */
        var disqus_shortname = 'lmovingon';
        
        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function () {
            var s = document.createElement('script'); s.async = true;
            s.type = 'text/javascript';
            s.src = '//' + disqus_shortname + '.disqus.com/count.js';
            (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
        }());
    </script>
</body>
</html>
